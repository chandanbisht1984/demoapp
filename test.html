import { Stack, App, StackProps, Fn, CfnOutput, ResourceEnvironment, SecretValue } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { CfnParametersCode, Code, Runtime, Function as LambdaFunction, Tracing  } from 'aws-cdk-lib/aws-lambda'
import {CfnParameter, Duration} from 'aws-cdk-lib'
import {CfnWebACL, CfnWebACLProps, CfnWebACLAssociation, CfnRuleGroup, CfnLoggingConfiguration} from "aws-cdk-lib/aws-wafv2";
import { Bucket, IBucket, BucketAccessControl } from 'aws-cdk-lib/aws-s3';
import {Role, ServicePrincipal, PolicyStatement, Effect, ManagedPolicy, Policy } from 'aws-cdk-lib/aws-iam';

import { Secret } from 'aws-cdk-lib/aws-secretsmanager';

// import { ServicePrincipals, ManagedPolicies } from 'aws-cdk-lib/consta';


import { getParam } from '../helpers/helpers';

import {RestApi, LambdaIntegration, MethodLoggingLevel, Cors} from 'aws-cdk-lib/aws-apigateway';

import {StringParameter} from 'aws-cdk-lib/aws-ssm';

// import main from '../../../apps/handler/adminAuthorizer'

import {
  CloudFrontWebDistribution, 
  CloudFrontWebDistributionProps,
  HttpVersion, 
  PriceClass, 
  ViewerProtocolPolicy, 
  CloudFrontAllowedMethods, 
  OriginProtocolPolicy, 
  OriginAccessIdentity, 
  SSLMethod , 
  SecurityPolicyProtocol, 
  IDistribution, 
  SourceConfiguration, 
  ViewerCertificate,
  CloudFrontAllowedCachedMethods,
  Distribution,
  experimental,
  DistributionProps,
  LambdaEdgeEventType,
  BehaviorOptions,
  IOrigin,
  AllowedMethods,
  CachePolicy
}from 'aws-cdk-lib/aws-cloudfront'
import { HostedZone, ARecord, RecordTarget, HostedZoneAttributes, IHostedZone } from 'aws-cdk-lib/aws-route53';
import { CloudFrontTarget } from 'aws-cdk-lib/aws-route53-targets';

import { ICertificate,Certificate } from 'aws-cdk-lib/aws-certificatemanager';

import { S3Origin, S3OriginProps ,RestApiOrigin, RestApiOriginProps} from 'aws-cdk-lib/aws-cloudfront-origins';


export interface  LambdaEdgeProps extends StackProps {
    name: string
    env: { 
      region: string
      account: string
    },
    lambdaFunctionArnParameterName: string;
 
  }
  
  export class LambdaEdgeStack extends Stack {
    public readonly code: CfnParametersCode;


    constructor(scope: Construct, id: string, props: LambdaEdgeProps) {
      super(scope, id, props)

      if (props.env?.region !== 'us-east-1') {
        throw new Error("The stack contains Lambda@Edge functions and must be deployed in 'us-east-1'");
      }
  
      // Policy.aws_
      // const { managedPolicyArn } = ManagedPolicy.fromAwsManagedPolicyName(
      //   ManagedPolicies.AWS_LAMBDA_BASIC_EXECUTION_ROLE
      // );

      this.code = Code.fromCfnParameters({
        bucketNameParam: new CfnParameter(this, 'CodeBucketName'),
        objectKeyParam: new CfnParameter(this, 'CodeBucketObjectKey')
      })



      // const adminAuthorizerLambda:LambdaFunction = new LambdaFunction(this, `${props.name}-adminAuthorizerLambda`, {
      //   code: Code.fromInline(`async function main(event:any,context:any, callback:any){
      //     const request = event.Records[0].cf.request;
      //     console.log(request);
      //     const authHeader = request.headers;
      
      //     console.log("Admin Post event:", event);
      
      //     console.log("Admin Post request:", request);
      
      //     console.log("Admin Post authHeader:", authHeader);
      
      //     try {
       
      //         console.log("API key  is valid.");
              
          
      //         callback(null, request);
      //       } catch (err) {
      //         console.log("Token not valid!", err);
          
      //         callback(null, {
      //           status: "403",
      //           body: "Unauthorized",
      //         });
      //       }
      //   };
      
      //   module.exports = {main};`),
      //   handler: 'index.main',
      //   runtime: Runtime.NODEJS_18_X,
      //   memorySize: 128,
      //   functionName: `${props.name}-WISPadminAuthorizerLambda`
      // })



    // new CfnOutput(this, 
    //   'adminAuthorizerArn', 
    // {
    //   value: adminAuthorizerLambda.functionArn,
    //   exportName: `${props.name}-adminAuthorizerArn`
    // });


    // const { functionArn =''} = adminAuthorizerLambda.currentVersion;

    // new StringParameter(this, 'LambdaFunctionArnParameter', {
    //   parameterName: props.lambdaFunctionArnParameterName,
    //   stringValue: functionArn,
    // });
    

    // new Secret(this, `${props.name}-lambdEdgeArn`, {
    //   secretName: `${props.name}-lambdEdgeArn`,
    //   description: `${props.name}-lambdEdgeArn`,
    //   secretStringValue: SecretValue.unsafePlainText(functionArn)
    // })

    // new CfnOutput(this, 
    //   'lambdaEdgeLambdaFunctionArn', 
    // {
    //   value: lambdaEdgeLambda.functionArn,
    //   exportName: `${this.stackName}-lambdaEdgeLambdaFunctionArn`
    // });
  

      
    }
    
}
